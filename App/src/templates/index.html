{% extends "base.html" %}
{% block content_title %}WinRM Demo{% endblock %}

{% block content %}
    <h4>Connection Specs</h4>
    <p style="margin-top: 0;">This demo utilizes the NTLM authentication model to communicate with the remote Windows Server.</p>

    <div class="clr-row">
        <div class="clr-col-4">
            <!-- CONNECTION INPUTS: SOURCE -->
            <div class="clr-form-control">
                <span class="clr-control-label">Windows Server</span>
                <div class="clr-control-container">
                    <div class="clr-input-wrapper">
                        <input type="text" class="clr-input" id="tServer" placeholder="Server IP / FQDN" style="width: 400px;"/>
                    </div>
                </div>
                <!-- HELPER TEXT -->
                <span class="clr-subtext">IP Address or FQDN of Windows Server</span>
            </div>
        </div>
        <div class="clr-col-4">
            <!-- CONNECTION INPUTS: USERNAME -->
            <div class="clr-form-control">
                <span class="clr-control-label">Username</span>
                <div class="clr-control-container">
                    <div class="clr-input-wrapper">
                        <input type="text" class="clr-input" id="tUser" placeholder="Domain\Username" style="width: 400px;"/>
                    </div>
                </div>
                <!-- HELPER TEXT -->
                <span class="clr-subtext">Windows Credentials</span>
            </div>
        </div>
        <div class="clr-col-4">
            <!-- CONNECTION INPUTS: PASSWORD -->
            <div class="clr-form-control">
                <span class="clr-control-label">Password</span>
                <div class="clr-control-container">
                    <div class="clr-input-wrapper">
                        <input type="password" class="clr-input" id="tPass" placeholder="Password" style="width: 400px;"/>
                    </div>
                </div>
                <!-- HELPER TEXT -->
                <span class="clr-subtext">Windows Password</span>
            </div>
        </div>
    </div>

    <div class="clr-row">
        <div class="clr-col-12">
            <!-- CONNECTION INPUTS: SOURCE -->
            <div class="clr-form-control">
                <span class="clr-control-label">PowerShell Command</span>
                <div class="clr-control-container">
                    <div class="clr-input-wrapper">
                        <input type="text" class="clr-input" id="tCmd" placeholder="PowerShell Command" value="$PSVersionTable | ConvertTo-Json" style="width: 800px;"/>
                    </div>
                </div>
            </div>
        </div>
    </div>
 
    <!-- CONNECT BUTTON -->
    <div class="clr-wizard-btn-wrapper" style="padding-top: 30px;">
        <button type="button" id="bRun" class="btn btn-primary" onclick="runPowershell()">Run</button>
        <button type="button" class="btn btn-outline" onclick="clearResults()">Clear</button>
    </div>

    <!-- RESULTS -->
    <p>Results</p>
    <pre style="min-height: 200px;" id="pResults"></pre>
{% endblock %}

{% block scripts %}
    <script>
        // FUNCTION: AJAX CALL TO UPDATE DEPLOYMENT STATUS
        function runPowershell(){
            // GET FORM DATA
            var SERVER = document.getElementById('tServer').value;
            var USERNAME = document.getElementById('tUser').value;
            var PASSWORD = document.getElementById('tPass').value;
            var CMD = document.getElementById('tCmd').value;

            // AJAX CALL
            fetch("/api/v1/powershell", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    server: SERVER, 
                    username: USERNAME,
                    password: PASSWORD,
                    cmd: CMD,
                })
            })
            .then((response) => {
                if (response.status !== 200){
                    console.log('[ERROR] Error Connecting to API Endpoint');
                    pResults.innerHTML = '[ERROR] Error Connecting to API Endpoint';
                    return ;
                }

                response.json().then((data) => {
                    // UPDATE RESULTS
                    document.getElementById('pResults').innerHTML = JSON.stringify(data.results, null, 2);              
                })
            })
        }
    
        // FUNCTION: CLEAR RESULTS
        function clearResults(){
            document.getElementById('pResults').innerHTML = '';
        }
    </script>
{% endblock %}